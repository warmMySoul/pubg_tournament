{% extends 'base.html' %}

{% block title %}
<title>GB Admin - Турниры</title>
{% endblock %}


{% block content %}
<div class="container">
    <section id="tournament-info" data-aos="fade-right" class="section">
        <a class="btn btn-primary" href="{{url_for('admin.admin')}}">Назад в Адимин-панель</a>
        <h2>Турниры</h2>
        <a class="btn btn-primary" href="{{url_for('admin.create_tournament')}}">Создать турнир</a>
        {% if tournaments %}
        <table>
            <tr>
                <th>Название</th>
                <th>Режим</th>
                <th>Регистрация</th>
                <th>Дата турнира</th>
                <th>Статус регистрации</th>
                <th>Количество участников</th>
                {% if current_user.role == "admin" %}
                <th>Действия</th>
                {% endif %}
            </tr>
            {% for tournament in tournaments %}
            <tr style="cursor: pointer;" onmouseover="this.style.backgroundColor='var(--dark-gold)'"
                onmouseout="this.style.backgroundColor='transparent'"
                onclick="handleRowClick(event, '{{ tournament.id }}')">
                <td>{{ tournament.name }}</td>
                <td>{{ tournament.mode }} </br> Кол-во карт: {{tournament.maps_count}} </td>
                <td>
                    {{ tournament.reg_start.strftime('%d.%m.%Y') }} -<br>
                    {{ tournament.reg_end.strftime('%d.%m.%Y') }}
                </td>
                <td>{{ tournament.tournament_date.strftime('%d.%m.%Y') }}</td>
                <td>
                    {% set now = now.replace(tzinfo=None) %}
                    {% if tournament.reg_start <= now <= tournament.reg_end %}
                    <span class="status-open">Открыта</span>
                    {% else %}
                    <span class="status-closed">Закрыта</span>
                    {% endif %}
                </td>
                <td>
                    {{ tournament.players|length }}
                </td>
                {% if current_user.role == "admin" %}
                <td class="">
                    
                    <span onclick='confirmDelete({{ tournament.id|tojson }})' class="control-icon pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="var(--red)">
                            <path
                                d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
                        </svg>
                    </span>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>Нет активных турниров</p>
        {% endif %}
    </section>
</div>

<div id="modalConfirm" class="modal_container">
    <div class="modal-content">
        <p id="modalText">Подтвердите действие</p>
        <button class="btn btn-danger" onclick="handleModalConfirm()">Да</button>
        <button class="btn btn-secondary" onclick="hideModal()">Отмена</button>
    </div>
</div>


{% endblock %}

{% block script %}
<script>
    // Нажатие на строчку
    function handleRowClick(event, tournament_id) {
        if (tournament_id) {
            if (event.target.tagName !== 'BUTTON' && event.target.tagName !== 'I') {
                window.location.href = "{{url_for('admin.tournament_info',tournament_id=tournament_id)}}" +
                    tournament_id;
            }
        }
    }

    let modalAction = null;
    let pendingDeleteId = null;


    function showConfirmModal(action) {
        modalAction = action;
        document.getElementById('modalText').innerText = action === 'edit' ? 'Подтвердить изменения турнира?' :
            'Удалить турнир?';
        document.getElementById('modalConfirm').style.display = 'flex';
    }

    function hideModal() {
        modalAction = null;
        pendingDeleteId = null;
        document.getElementById('modalConfirm').style.display = 'none';
    }

    function handleModalConfirm() {
        if (modalAction === 'edit') {
            fetch('/admin/api/edit_tournament', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tournament_id: document.getElementById('edit_id').value,
                    name: document.getElementById('edit_name').value,
                    mode: document.getElementById('edit_mode').value,
                    scoring: document.getElementById('edit_scoring').value,
                    confirm: true
                })
            }).then(res => res.json()).then(data => {
                if (data.success) location.reload();
                else alert('Ошибка: ' + (data.error || 'Не удалось сохранить'));
            });
        }
        if (modalAction === 'delete' && pendingDeleteId) {
            fetch('/admin/api/delete_tournament', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tournament_id: pendingDeleteId,
                    confirm: true
                })
            }).then(res => res.json()).then(data => {
                if (data.success) location.reload();
                else alert('Ошибка: ' + (data.error || 'Не удалось удалить'));
            });
        }
        hideModal();
    }

    function confirmDelete(id) {
        pendingDeleteId = id;
        showConfirmModal('delete');
    }

    function toggleProfileMenu() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    window.onclick = function (event) {
        if (!event.target.closest('.profile-menu')) {
            document.getElementById('profileDropdown').style.display = 'none';
        }
    }

</script>
{% endblock %}